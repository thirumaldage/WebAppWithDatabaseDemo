trigger: 'none' # will disable CI builds entirely

pool:
  vmImage: 'windows-2019'
    
variables:
  BuildConfiguration: release
  
stages:
- stage: Build_Stage
  jobs:
  - job: Build_Job
    displayName: Build WebApp
    pool:
      name: Hosted Windows 2019 with VS2019 
      vmImage: 'windows-2019'
    variables:
      BuildConfiguration: release
    steps:
    - task: UseDotNet@2
      displayName: Install .NET 6 sdk
      inputs:
        packageType: sdk
        version: 6.0.x
        installationPath: $(Agent.ToolsDirectory)/dotnet

    - task: DotNetCoreCLI@2
      displayName: Restore Nuget Packages
      inputs:
        command: restore
        projects: '**/WebApp.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build Web App
      inputs:
        projects: '**/WebApp.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Run Unit Tests
      inputs:
        command: test
        projects: '**/*UnitTest*.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Create Web App Package (.zip)
      inputs:
        command: publish
        publishWebProjects: True
        arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'
        zipAfterPublish: True

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact (WebApp.zip)'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
          
  - job: ManualApproval
    displayName: 'Manaul Approval'
    dependsOn: Build_Job
    pool: server
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 30
      inputs:
        notifyUsers: "dthirumalrao@hotmail.com"
        instructions: "Please approve the web app build"
        onTimeout: reject
- stage: 
  displayName: Depoy_stage
  dependsOn: Build_Stage
  jobs:
  - job: Deploy_Job
    displayName: DeployDisplayName
    pool:
     name: Hosted Windows 2019 with VS2019 
     vmImage: 'windows-2019'
    steps:

    - task: DownloadBuildArtifacts@1
      displayName: Download WebApp.zip
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        itemPattern: '**/WebApp.zip'
        downloadPath: '$(System.DefaultWorkingDirectory)'
    - task: AzureRmWebAppDeployment@4
      displayName: Deploy Web App
      inputs:
        ConnectionType: 'AzureRM'
        azureSubscription: 'AzureServiceprinicipalConnection'
        appType: 'webApp'
        WebAppName: 'dotnet-core-mvc1'
        packageForLinux: '$(System.DefaultWorkingDirectory)/**/*.zip'
        JSONFiles: '**/appsettings.json'